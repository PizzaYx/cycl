{"version":3,"file":"user.js","sources":["stores/user.js"],"sourcesContent":["// stores/user.js\nimport { defineStore } from 'pinia'\nimport { apiGetInfo } from '@/api/apis.js'\n\nexport const useUserStore = defineStore('user', {\n    state: () => ({\n        userInfo: null,\n        isLoggedIn: false,\n    }),\n\n    getters: {\n        // 用户昵称\n        nickName: (state) => state.userInfo?.nickName || '',\n\n        // 用户名\n        userName: (state) => state.userInfo?.userName || '',\n\n        // 用户ID\n        userId: (state) => state.userInfo?.userId || null,\n\n        //merchant 商户信息\n        merchant: (state) => state.userInfo?.merchant || null,\n\n        //收运端--师傅信息\n        sfmerchant: (state) => state.userInfo?.driver || null,\n\n        // 商户头像（使用昵称第一个字）\n        userAvatar: (state) => {\n            const name = state.userInfo?.name\n            // 如果有昵称，取第一个字；如果没有，显示默认头像文字\n            return name ? name.charAt(0) : '商'\n        },\n\n        //收运端--师傅头像\n        userSFAvatar: (state) => {\n            const name = state.userInfo?.nickName\n            // 如果有昵称，取第一个字；如果没有，显示默认头像文字\n            return name ? name.charAt(0) : '收'\n        },\n\n        // 是否已认证（merchant不为null且status为1表示已认证）\n        isVerified: (state) => state.userInfo?.merchant !== null && state.userInfo?.merchant?.status === 1,\n\n        // 认证状态：0=未审核/待审核，1=认证成功，2=审核不通过\n        merchantStatus: (state) => {\n            if (!state.userInfo?.merchant) {\n                return null // 未提交认证\n            }\n            return state.userInfo.merchant.status\n        },\n\n        // 认证状态文字\n        merchantStatusText: (state) => {\n            const status = state.userInfo?.merchant?.status\n            switch (status) {\n                case 0:\n                    return '待审核'\n                case 1:\n                    return '认证成功'\n                case 2:\n                    return '审核不通过'\n                default:\n                    return '未认证'\n            }\n        },\n\n        // 用户类型（1=商户，2=收运）\n        userType: (state) => state.userInfo?.type || '1',\n\n        // 用户类型文字\n        userTypeText: (state) => {\n            const type = state.userInfo?.type\n            return type === '1' ? '商户端' : type === '2' ? '收运端' : '未知'\n        },\n\n    },\n\n    actions: {\n        // 设置用户信息（仅存储在内存中）\n        setUserInfo(userInfo) {\n            this.userInfo = userInfo\n            this.isLoggedIn = true\n        },\n\n        // 从服务器获取用户信息\n        async fetchUserInfo() {\n            try {\n                const res = await apiGetInfo()\n                // 检查响应是否存在\n                if (!res) {\n                    console.log('响应为空，可能是401跳转情况')\n                    return null\n                }\n                const responseData = res.data || res\n                const code = responseData.code\n\n                if (code === 200) {\n                    this.setUserInfo(res.user || responseData.user)\n                    return res.user || responseData.user\n                } else if (code === 401) {\n                    // 401错误已被request.js处理（跳转登录），这里不需要抛出异常\n                    console.log('用户未登录，已跳转到登录页')\n                    return null\n                } else {\n                    console.log('获取用户信息失败，code:', code, 'msg:', responseData.msg)\n                    // 不抛出异常，而是返回null\n                    return null\n                }\n            } catch (error) {\n                console.log('获取用户信息异常:', error.message || error)\n                // 不重新抛出异常，而是返回null\n                return null\n            }\n        },\n\n        // 更新用户信息（仅内存更新）\n        updateUserInfo(updates) {\n            if (this.userInfo) {\n                this.userInfo = { ...this.userInfo, ...updates }\n                console.log('用户信息已更新:', this.userInfo)\n            }\n        },\n\n        // 检查是否有用户信息，没有则自动获取\n        async ensureUserInfo() {\n            // 如果已有用户信息，直接返回\n            if (this.userInfo) {\n                return this.userInfo\n            }\n\n            // 尝试获取用户信息（request.js会自动处理token验证）\n            const result = await this.fetchUserInfo()\n            if (result === null) {\n                // 获取失败（可能是401、网络错误等），返回null而不抛出异常\n                console.log('用户信息获取失败，可能未登录或网络异常')\n                return null\n            }\n            return this.userInfo\n        },\n\n        // 清除用户信息\n        clearUserInfo() {\n            this.userInfo = null\n            this.isLoggedIn = false\n            console.log('用户信息已清除')\n        },\n\n        // 退出登录\n        logout() {\n            // 清除用户信息\n            this.clearUserInfo()\n\n            // 清除token\n            uni.removeStorageSync('access_token')\n            uni.removeStorageSync('access_expire_time')\n            uni.removeStorageSync('refresh_token')\n            uni.removeStorageSync('refresh_expire_time')\n\n            console.log('用户已退出登录')\n\n            // 跳转到登录页\n            uni.redirectTo({\n                url: '/pages/index/index'\n            })\n        }\n    }\n})\n"],"names":["defineStore","apiGetInfo","uni"],"mappings":"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"}