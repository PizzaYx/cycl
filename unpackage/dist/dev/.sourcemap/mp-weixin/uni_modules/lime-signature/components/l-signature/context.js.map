{"version":3,"file":"context.js","sources":["uni_modules/lime-signature/components/l-signature/context.js"],"sourcesContent":["const uniPlatform = uni.getSystemInfoSync().uniPlatform\r\n\r\nexport const uniContext = (canvasId, context) => {\r\n\tlet ctx = uni.createCanvasContext(canvasId, context)\r\n\tif (!ctx.uniDrawImage) {\r\n\t\tctx.uniDrawImage = ctx.drawImage\r\n\t\tctx.drawImage = (image, ...agrs) => {\r\n\t\t\tctx.uniDrawImage(image.src, ...agrs)\r\n\t\t}\r\n\t}\r\n\r\n\tif (!ctx.getImageData) {\r\n\t\tctx.getImageData = (x, y, width, height) => {\r\n\t\t\treturn new Promise((resolve, reject) => {\r\n\t\t\t\t// #ifdef MP || VUE2\r\n\t\t\t\tif (context.proxy) context = context.proxy\r\n\t\t\t\t// #endif\r\n\t\t\t\tuni.canvasGetImageData({\r\n\t\t\t\t\tcanvasId,\r\n\t\t\t\t\tx,\r\n\t\t\t\t\ty,\r\n\t\t\t\t\twidth:parseInt(width),\r\n\t\t\t\t\theight:parseInt(height),\r\n\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\tresolve(res)\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail(error) {\r\n\t\t\t\t\t\treject(error)\r\n\t\t\t\t\t}\r\n\t\t\t\t}, context)\r\n\t\t\t})\r\n\t\t}\r\n\t} else {\r\n\t\tctx._getImageData = ctx.getImageData\r\n\t\tctx.getImageData = (x, y, width, height) => {\r\n\t\t\treturn new Promise((resolve, reject) => {\r\n\t\t\t\tctx._getImageData({\r\n\t\t\t\t\tx,\r\n\t\t\t\t\ty,\r\n\t\t\t\t\twidth: parseInt(width) ,\r\n\t\t\t\t\theight:parseInt(height),\r\n\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\tresolve(res)\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail(error) {\r\n\t\t\t\t\t\treject(error)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t}\r\n\t}\r\n\r\n\treturn ctx\r\n}\r\n\r\nclass Image {\r\n\tconstructor() {\r\n\t\tthis.currentSrc = null\r\n\t\tthis.naturalHeight = 0\r\n\t\tthis.naturalWidth = 0\r\n\t\tthis.width = 0\r\n\t\tthis.height = 0\r\n\t\tthis.tagName = 'IMG'\r\n\t}\r\n\tonerror() {}\r\n\tonload() {}\r\n\tset src(src) {\r\n\t\tthis.currentSrc = src\r\n\t\tuni.getImageInfo({\r\n\t\t\tsrc,\r\n\t\t\tsuccess: (res) => {\r\n\t\t\t\tthis.naturalWidth = this.width = res.width\r\n\t\t\t\tthis.naturalHeight = this.height = res.height\r\n\t\t\t\tthis.onload()\r\n\t\t\t},\r\n\t\t\tfail: () => {\r\n\t\t\t\tthis.onerror()\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\tget src() {\r\n\t\treturn this.currentSrc\r\n\t}\r\n}\r\n\r\nexport const createImage = () => {\r\n\treturn new Image()\r\n}\r\nexport function useCurrentPage() {\r\n\tconst pages = getCurrentPages();\r\n\treturn pages[pages.length - 1];\r\n}\r\nexport const toDataURL = (canvasId, context, options = {}) => {\r\n\t// #ifdef MP-QQ\r\n\t// context = context.$scope\r\n\t// #endif\r\n\t// #ifdef MP-ALIPAY\r\n\tcontext = ''\r\n\t// #endif\r\n\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tlet {\r\n\t\t\tcanvas,\r\n\t\t\twidth,\r\n\t\t\theight,\r\n\t\t\tdestWidth = 0,\r\n\t\t\tdestHeight = 0,\r\n\t\t\tx = 0,\r\n\t\t\ty = 0,\r\n\t\t\tpreferToDataURL\r\n\t\t} = options\r\n\t\tconst {\r\n\t\t\tpixelRatio\r\n\t\t} = uni.getSystemInfoSync()\r\n\t\t\r\n\t\t// #ifdef MP-ALIPAY\r\n\t\tconst isDD = typeof dd != 'undefined'\r\n\t\tif (!isDD && (!destWidth || !destHeight)) {\r\n\t\t\tdestWidth = width * pixelRatio;\r\n\t\t\tdestHeight = height * pixelRatio;\r\n\t\t\twidth = destWidth;\r\n\t\t\theight = destHeight;\r\n\t\t\tx = x * pixelRatio\r\n\t\t\ty = y * pixelRatio\r\n\t\t}\r\n\t\t// #endif\r\n\t\tconst params = {\r\n\t\t\t...options,\r\n\t\t\tcanvasId,\r\n\t\t\tid: canvasId,\r\n\t\t\t// #ifdef MP-ALIPAY\r\n\t\t\tx,\r\n\t\t\ty,\r\n\t\t\twidth,\r\n\t\t\theight,\r\n\t\t\tdestWidth,\r\n\t\t\tdestHeight,\r\n\t\t\t// #endif\r\n\t\t\tcanvas,\r\n\t\t\tsuccess: (res) => {\r\n\t\t\t\t// 钉钉小程序 不存在tempFilePath\r\n\t\t\t\tresolve(res.tempFilePath || res.filePath)\r\n\t\t\t},\r\n\t\t\tfail: (err) => {\r\n\t\t\t\treject(err)\r\n\t\t\t}\r\n\t\t}\r\n\t\t// 抖音小程序canvas 2d不支持canvasToTempFilePath\r\n\t\tif (canvas && canvas.toDataURL && preferToDataURL) {\r\n\t\t\tlet next = true\r\n\t\t\tconst devtools = uni.getSystemInfoSync().platform == 'devtools'\r\n\t\t\t// #ifdef MP-TOUTIAO\r\n\t\t\tnext = uni.getSystemInfoSync().platform != 'devtools'\r\n\t\t\tif (!next) {\r\n\t\t\t\tconsole.warn('[lime-signature] 抖音开发工具不支持bbox')\r\n\t\t\t}\r\n\t\t\t// #endif\r\n\t\t\tif ((x || y) && next) {\r\n\t\t\t\tconst offCanvas = uni.createOffscreenCanvas({\r\n\t\t\t\t\ttype: '2d'\r\n\t\t\t\t});\r\n\t\t\t\tconst ctx = offCanvas.getContext(\"2d\");\r\n\t\t\t\tconst destWidth = Math.floor(width * pixelRatio)\r\n\t\t\t\tconst destHeight = Math.floor(height * pixelRatio)\r\n\t\t\t\toffCanvas.width = destWidth // canvas.width;\r\n\t\t\t\toffCanvas.height = destHeight // canvas.height;\r\n\t\t\t\t// ctx.scale(pixelRatio, pixelRatio)\r\n\t\t\t\t// ctx.drawImage(canvas, Math.floor(x*pixelRatio), Math.floor(y*pixelRatio), destWidth, destHeight, 0,0, destWidth, destHeight);\r\n\t\t\t\t// 抖音不能在drawImage使用canvas\r\n\t\t\t\tconst image = canvas.createImage()\r\n\t\t\t\timage.onload = () => {\r\n\t\t\t\t\tctx.drawImage(image, Math.floor(x * pixelRatio), Math.floor(y * pixelRatio),\r\n\t\t\t\t\t\tdestWidth, destHeight, 0, 0, destWidth, destHeight)\r\n\t\t\t\t\tconst tempFilePath = offCanvas.toDataURL();\r\n\t\t\t\t\tresolve(tempFilePath)\r\n\t\t\t\t\tif (params.success) {\r\n\t\t\t\t\t\tparams.success({\r\n\t\t\t\t\t\t\ttempFilePath\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\timage.src = canvas.toDataURL()\r\n\r\n\t\t\t} else {\r\n\t\t\t\tconst tempFilePath = canvas.toDataURL()\r\n\t\t\t\tresolve(tempFilePath)\r\n\t\t\t\tif (params.success) {\r\n\t\t\t\t\tparams.success({\r\n\t\t\t\t\t\ttempFilePath\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (canvas && canvas.toTempFilePath) {\r\n\t\t\tcanvas.toTempFilePath(params)\r\n\t\t} else {\r\n\t\t\tuni.canvasToTempFilePath(params, context)\r\n\t\t}\r\n\t})\r\n\r\n}"],"names":["uni","destWidth","destHeight"],"mappings":"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"}