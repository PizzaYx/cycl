{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["// utils/request.js\nconst BASE_URL = 'http://192.168.0.118:8089'\n\n// 存储刷新token的Promise，避免并发请求时重复刷新\nlet refreshingPromise = null\n\n// 请求拦截器\nuni.addInterceptor('request', {\n    invoke(args) {\n        // 添加基础URL\n        if (!args.url.startsWith('http')) {\n            args.url = BASE_URL + args.url\n        }\n\n        // 添加access token到请求头\n        const accessToken = uni.getStorageSync('access_token')\n        console.log('Access Token:', accessToken); // 调试输出\n        if (accessToken) {\n            args.header = args.header || {}\n            args.header['authorization'] = `Bearer ${accessToken}`\n        }\n\n        return args\n    },\n})\n\n// 响应拦截器\nuni.addInterceptor('request', {\n    success: async (res) => {\n        // 处理401未授权\n        if (res.statusCode === 401) {\n            try {\n                await handleUnauthorized()\n                // 刷新token后重新发起请求\n                const newToken = uni.getStorageSync('access_token')\n                if (newToken) {\n                    // 重新发起请求\n                    const originalRequest = res.config || {}\n                    originalRequest.header = originalRequest.header || {}\n                    originalRequest.header['authorization'] = `Bearer ${newToken}`\n\n                    return uni.request(originalRequest)\n                } else {\n                    // 刷新失败，跳转登录\n                    logout()\n                    return Promise.reject(res)\n                }\n            } catch (error) {\n                // 刷新失败，跳转登录\n                logout()\n                return Promise.reject(res)\n            }\n        } else if (res.data.code === 200) {\n            // 特殊处理：如果响应包含token信息，自动保存token（登录接口）\n            if (\n                res.data.data &&\n                res.data.data.access_token &&\n                res.data.data.refresh_token\n            ) {\n                saveToken(res.data.data)\n            }\n            return res.data\n        } else {\n            handleRequestError(res.data)\n            return Promise.reject(res.data)\n        }\n    },\n    fail: (err) => {\n        return Promise.reject(err)\n    },\n})\n\n// 简化的请求函数\nexport function request(config = {}) {\n    const { url, data = {}, method = 'GET', header = {}, ...rest } = config\n\n    return uni.request({\n        url,\n        data,\n        method,\n        header,\n        ...rest,\n    })\n}\n\n/**\n * 处理未授权情况\n */\nasync function handleUnauthorized() {\n    // 如果正在刷新token，则等待刷新完成\n    if (refreshingPromise) {\n        return refreshingPromise\n    }\n\n    try {\n        // 检查refresh token是否过期\n        const refreshTokenStr = uni.getStorageSync('refresh_token')\n        const refreshExpireTime = uni.getStorageSync('refresh_expire_time')\n\n        if (!refreshTokenStr || !refreshExpireTime) {\n            // refresh token不存在，直接跳转登录\n            throw new Error('未登录')\n        }\n\n        // 检查refresh token是否过期\n        const now = Date.now()\n        if (now > refreshExpireTime) {\n            // refresh token过期，跳转登录\n            throw new Error('登录已过期')\n        }\n\n        // 刷新token\n        refreshingPromise = refreshAccessToken(refreshTokenStr)\n\n        await refreshingPromise\n    } finally {\n        // 清除刷新状态\n        refreshingPromise = null\n    }\n}\n\n/**\n * 刷新access token\n */\nasync function refreshAccessToken(refreshTokenStr) {\n    const res = await post('/api/apiRefresh', {\n        refresh_token: refreshTokenStr,\n    })\n\n    if (res.code === 200) {\n        // 保存新的token信息\n        saveToken(res.data)\n        return res\n    } else {\n        // 刷新失败，清除本地存储\n        clearToken()\n        throw new Error(res.msg || '刷新token失败')\n    }\n}\n\n/**\n * 保存token信息\n */\nfunction saveToken(tokenData) {\n    const now = Date.now()\n\n    // 保存access token\n    uni.setStorageSync('access_token', tokenData.access_token)\n    uni.setStorageSync('access_expire_time', now + tokenData.access_expire_time * 1000)\n\n    // 保存refresh token\n    uni.setStorageSync('refresh_token', tokenData.refresh_token)\n    uni.setStorageSync('refresh_expire_time', now + tokenData.refresh_expire_time * 1000)\n}\n\n/**\n * 清除token信息\n */\nfunction clearToken() {\n    uni.removeStorageSync('access_token')\n    uni.removeStorageSync('access_expire_time')\n    uni.removeStorageSync('refresh_token')\n    uni.removeStorageSync('refresh_expire_time')\n}\n\n/**\n * 退出登录\n */\nfunction logout() {\n    clearToken()\n    // 跳转到登录页面\n    uni.redirectTo({\n        url: '/pages/index/index',\n    })\n}\n\n/**\n * 处理请求错误\n */\nfunction handleRequestError(data) {\n    if (data.msg) {\n        uni.showToast({\n            title: data.msg,\n            icon: 'none',\n        })\n    }\n}\n\nexport default {\n    request\n}\n"],"names":["uni"],"mappings":"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"}