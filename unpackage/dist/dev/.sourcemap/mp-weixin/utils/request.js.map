{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["// utils/request.js\r\nconst BASE_URL = 'http://192.168.0.200:8080'\r\n\r\n// 存储刷新token的Promise，避免并发请求时重复刷新\r\nlet refreshingPromise = null\r\n\r\n// 请求拦截器\r\nuni.addInterceptor('request', {\r\n  invoke(args) {\r\n    // 添加基础URL\r\n    if (!args.url.startsWith('http')) {\r\n      args.url = BASE_URL + args.url\r\n    }\r\n\r\n    // 添加access token到请求头\r\n        const accessToken = uni.getStorageSync('access_token')\r\n        console.log('Access Token:', accessToken); // 调试输出\r\n    if (accessToken) {\r\n      args.header = args.header || {}\r\n      args.header['authorization'] = `Bearer ${accessToken}`\r\n    }\r\n\r\n    return args\r\n  },\r\n})\r\n\r\n// 响应拦截器\r\nuni.addInterceptor('request', {\r\n  success: async (res) => {\r\n    // 处理401未授权\r\n    if (res.statusCode === 401) {\r\n      try {\r\n        await handleUnauthorized()\r\n        // 刷新token后重新发起请求\r\n        const newToken = uni.getStorageSync('access_token')\r\n        if (newToken) {\r\n          // 重新发起请求\r\n          const originalRequest = res.config || {}\r\n          originalRequest.header = originalRequest.header || {}\r\n          originalRequest.header['authorization'] = `Bearer ${newToken}`\r\n\r\n          return uni.request(originalRequest)\r\n        } else {\r\n          // 刷新失败，跳转登录\r\n          logout()\r\n          return Promise.reject(res)\r\n        }\r\n      } catch (error) {\r\n        // 刷新失败，跳转登录\r\n        logout()\r\n        return Promise.reject(res)\r\n      }\r\n    } else if (res.data.code === 200) {\r\n      // 特殊处理：如果是登录接口，自动保存token\r\n      if (\r\n        res.config &&\r\n        res.config.url &&\r\n        res.config.url.includes('/api/apiLogin') &&\r\n        res.data.data &&\r\n        res.data.data.access_token\r\n      ) {\r\n\t\t  console.log(\"登录接口\");\r\n\t\t  console.log(res.data.data);\r\n        saveToken(res.data.data)\r\n      }\r\n      return res.data\r\n    } else {\r\n      handleRequestError(res.data)\r\n      return Promise.reject(res.data)\r\n    }\r\n  },\r\n  fail: (err) => {\r\n    return Promise.reject(err)\r\n  },\r\n})\r\n\r\n// 简化的请求函数\r\nexport function request(config = {}) {\r\n  const { url, data = {}, method = 'GET', header = {}, ...rest } = config\r\n\r\n  return uni.request({\r\n    url,\r\n    data,\r\n    method,\r\n    header,\r\n    ...rest,\r\n  })\r\n}\r\n\r\n/**\r\n * 处理未授权情况\r\n */\r\nasync function handleUnauthorized() {\r\n  // 如果正在刷新token，则等待刷新完成\r\n  if (refreshingPromise) {\r\n    return refreshingPromise\r\n  }\r\n\r\n  try {\r\n    // 检查refresh token是否过期\r\n    const refreshTokenStr = uni.getStorageSync('refresh_token')\r\n    const refreshExpireTime = uni.getStorageSync('refresh_expire_time')\r\n\r\n    if (!refreshTokenStr || !refreshExpireTime) {\r\n      // refresh token不存在，直接跳转登录\r\n      throw new Error('未登录')\r\n    }\r\n\r\n    // 检查refresh token是否过期\r\n    const now = Date.now()\r\n    if (now > refreshExpireTime) {\r\n      // refresh token过期，跳转登录\r\n      throw new Error('登录已过期')\r\n    }\r\n\r\n    // 刷新token\r\n    refreshingPromise = refreshAccessToken(refreshTokenStr)\r\n\r\n    await refreshingPromise\r\n  } finally {\r\n    // 清除刷新状态\r\n    refreshingPromise = null\r\n  }\r\n}\r\n\r\n/**\r\n * 刷新access token\r\n */\r\nasync function refreshAccessToken(refreshTokenStr) {\r\n  const res = await post('/api/apiRefresh', {\r\n    refresh_token: refreshTokenStr,\r\n  })\r\n\r\n  if (res.code === 200) {\r\n    // 保存新的token信息\r\n    saveToken(res.data)\r\n    return res\r\n  } else {\r\n    // 刷新失败，清除本地存储\r\n    clearToken()\r\n    throw new Error(res.msg || '刷新token失败')\r\n  }\r\n}\r\n\r\n/**\r\n * 保存token信息\r\n */\r\nfunction saveToken(tokenData) {\r\n  const now = Date.now()\r\n\r\n  // 保存access token\r\n  uni.setStorageSync('access_token', tokenData.access_token)\r\n  uni.setStorageSync('access_expire_time', now + tokenData.access_expire_time * 1000)\r\n\r\n  // 保存refresh token\r\n  uni.setStorageSync('refresh_token', tokenData.refresh_token)\r\n  uni.setStorageSync('refresh_expire_time', now + tokenData.refresh_expire_time * 1000)\r\n}\r\n\r\n/**\r\n * 清除token信息\r\n */\r\nfunction clearToken() {\r\n  uni.removeStorageSync('access_token')\r\n  uni.removeStorageSync('access_expire_time')\r\n  uni.removeStorageSync('refresh_token')\r\n  uni.removeStorageSync('refresh_expire_time')\r\n}\r\n\r\n/**\r\n * 退出登录\r\n */\r\nfunction logout() {\r\n  clearToken()\r\n  // 跳转到登录页面\r\n  uni.redirectTo({\r\n    url: '/pages/index/index',\r\n  })\r\n}\r\n\r\n/**\r\n * 处理请求错误\r\n */\r\nfunction handleRequestError(data) {\r\n  if (data.msg) {\r\n    uni.showToast({\r\n      title: data.msg,\r\n      icon: 'none',\r\n    })\r\n  }\r\n}\r\n\r\nexport default {\r\n  request\r\n}\r\n"],"names":["uni"],"mappings":"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"}