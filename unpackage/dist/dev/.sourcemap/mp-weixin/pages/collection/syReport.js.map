{"version":3,"file":"syReport.js","sources":["pages/collection/syReport.vue","pages/collection/syReport.vue?type=page"],"sourcesContent":["<!-- 收运记录 -->\n<template>\n    <view class=\"container\">\n        <uni-nav-bar dark :fixed=\"true\" background-color=\"#fff\" status-bar left-icon=\"left\" color=\"#000\" title=\"收运记录\"\n            @clickLeft=\"back\" />\n        <!-- 添加商店信息和扫码区域 -->\n        <view class=\"store-info\">\n            <view class=\"store-name\">商店名称</view>\n            <view class=\"bin-info\">\n                <text>垃圾桶个数: {{ ljNum }}个</text>\n                <uni-icons type=\"scan\" size=\"24\" color=\"#07C160\" class=\"scan-icon\" @click=\"handleScan\" />\n            </view>\n        </view>\n        <scroll-view class=\"content\" scroll-y>\n            <view class=\"record-list\">\n                <view v-for=\"(item, index) in records\" :key=\"index\" class=\"record-card\">\n                    <view class=\"input-group\">\n                        <view class=\"input-item\">\n                            <text class=\"label\"><text class=\"required\">*</text>垃圾桶数（个）</text>\n                            <input type=\"number\" \n                                v-model=\"item.binCount\" \n                                class=\"input underline-input readonly\"\n                                disabled\n                                placeholder=\"1\" />\n                        </view>\n                        <view class=\"input-item\">\n                            <text class=\"label\"><text class=\"required\">*</text>厨余垃圾重量（kg）</text>\n                            <input type=\"number\" \n                                v-model=\"item.weight\" \n                                class=\"input underline-input\" \n                                :class=\"{ 'readonly-input': item.isConfirmed }\"\n                                :disabled=\"item.isConfirmed\"\n                                placeholder=\"请输入垃圾重量\" />\n                        </view>\n                    </view>\n\n                    <view class=\"upload-section\">\n                        <text class=\"label\"><text class=\"required\">*</text>厨余垃圾照片</text>\n                        <view class=\"upload-area\">\n                            <uni-file-picker \n                                v-model=\"item.images\" \n                                file-mediatype=\"image\" \n                                :limit=\"maxImageCount\"\n                                :auto-upload=\"true\" \n                                :upload-url=\"uploadUrl\" \n                                :header=\"uploadHeaders\" \n                                :disabled=\"item.isConfirmed\"\n                                :readonly=\"item.isConfirmed\"\n                                return-type=\"array\"\n                                @select=\"(e) => handleFileSelect(e, index)\"\n                                @success=\"(e) => handleFileSuccess(e, index)\"\n                                @fail=\"(e) => handleFileFail(e, index)\">\n                            </uni-file-picker>\n                            <text class=\"upload-tip\">最多可上传{{ maxImageCount }}张图片，每张图片不超过3M</text>\n                        </view>\n                    </view>\n\n                    <view class=\"button-group\">\n                        <button v-if=\"!item.isConfirmed\" class=\"btn btn-cancel\" @click=\"handleCancel(index)\">取消</button>\n                        <button v-if=\"!item.isConfirmed\" class=\"btn btn-confirm\" @click=\"handleConfirm(index)\">确认</button>\n                    </view>\n                </view>\n            </view>\n        </scroll-view>\n    </view>\n</template>\n\n<script setup>\n// @ts-nocheck\nimport { ref } from 'vue';\nimport { onLoad, onUnload } from '@dcloudio/uni-app'; // 正确导入onLoad生命周期\nimport { uploadUrl, createUploadHeaders } from '@/utils/config.js';\nimport {apiPostreportWeight } from '@/api/apis.js'\n\n// 返回上一页\nconst back = () => {\n    // 返回前发送事件通知sfDetails页面刷新\n    uni.$emit('refreshSfDetails');\n    uni.navigateBack();\n};\n\nconst ljNum = ref(1); // 垃圾桶数量\nconst maxImageCount = 3; // 最大上传图片数量\nconst maxImageSize = 3 * 1024 * 1024; // 每张图片最大大小 3M\n\n// 新增接收页面参数的变量\nconst carId = ref(''); // 车辆ID\nconst driverId = ref(''); // 司机ID\nconst merchantId = ref(''); // 商户ID\nconst planId = ref(''); // 收运单ID\n\nconst uploadHeaders = createUploadHeaders()\n\nconst records = ref([\n    {\n        binCount: '',\n        weight: '',\n        images: [], // 改为数组存储多张图片\n        isConfirmed: false // 添加确认状态\n    }\n]);\n\n// 页面加载时获取传入的参数\nonLoad((options) => {\n    if (options.carId) carId.value = options.carId;\n    if (options.driverId) driverId.value = options.driverId;\n    if (options.merchantId) merchantId.value = options.merchantId;\n    if (options.planId) planId.value = options.planId;\n    console.log('接收到的参数:', options);\n});\n\n// 文件选择事件处理\nconst handleFileSelect = (event, index) => {\n    // 手动更新对应记录的images数据\n    if (event.tempFiles && event.tempFiles.length > 0) {\n        // 将新文件添加到现有images数组中，而不是替换整个数组\n        const newImages = [...(records.value[index].images || []), ...event.tempFiles];\n        // 更新对应记录的images数据\n        records.value[index].images = newImages;\n    }\n};\n\nconst handleFileSuccess = (event, index) => {\n    console.log('文件上传成功', event);\n};\n\nconst handleFileFail = (event, index) => {\n    console.log('文件上传失败', event);\n};\n\nconst handleScan = () => {\n    // @ts-ignore\n    uni.scanCode({\n        success: (res) => {\n            console.log('扫码结果', res);\n            // 扫描成功后添加一条新记录\n            records.value.push({\n                binCount: '',\n                weight: '',\n                images: [],\n                isConfirmed: false // 添加确认状态\n            });\n            // 增加垃圾桶数量\n            ljNum.value++;\n        },\n        fail: (err) => {\n            console.log('扫码失败', err);\n            // 即使扫描失败也添加一条新记录（模拟）\n            records.value.push({\n                binCount: '',\n                weight: '',\n                images: [],\n                isConfirmed: false // 添加确认状态\n            });\n            // 增加垃圾桶数量\n            ljNum.value++;\n        }\n    });\n};\n\nconst handleCancel = (index) => {\n    // 如果只有一条数据，不允许删除\n    if (records.value.length <= 1) {\n        uni.showToast({\n            title: '至少保留一条数据',\n            icon: 'none'\n        });\n        return;\n    }\n\n    // 弹出确认对话框\n    uni.showModal({\n        title: '确认删除',\n        content: '是否确认删除当前数据？',\n        success: (res) => {\n            if (res.confirm) {\n                // 用户点击确定，删除当前记录\n                records.value.splice(index, 1);\n                // 减少垃圾桶数量\n                ljNum.value--;\n            }\n        }\n    });\n};\n\n//验证\nconst handleConfirm = (index) => {\n    const record = records.value[index];\n    \n    // 验证重量是否输入\n    if (!record.weight || record.weight.trim() === '') {\n        uni.showToast({\n            title: '请输入垃圾重量',\n            icon: 'none'\n        });\n        return;\n    }\n    \n    // 验证是否至少上传了一张图片\n    // 1. 检查数据是否存在\n    if (record.images === undefined || record.images === null) {\n        uni.showToast({\n            title: '请至少上传1张图片',\n            icon: 'none'\n        });\n        return;\n    }\n\n    // 2. 检查是否为数组\n    if (!Array.isArray(record.images)) {\n        uni.showToast({\n            title: '请至少上传1张图片',\n            icon: 'none'\n        });\n        return;\n    }\n\n    // 3. 检查数组是否为空\n    if (record.images.length === 0) {\n        uni.showToast({\n            title: '请至少上传1张图片',\n            icon: 'none'\n        });\n        return;\n    }\n\n    // 4. 检查是否有有效的文件\n    const validFiles = record.images.filter((file) => {\n        if (!file) {\n            return false;\n        }\n\n        // 检查各种可能的文件格式\n        const hasUrl = file.url && file.url.trim();\n        const hasPath = file.path && file.path.trim();\n        const hasResponse = file.response && file.response.url;\n        const isString = typeof file === 'string' && file.trim();\n        const hasFileId = file.fileID || file.id;\n        const hasName = file.name;\n        const hasSize = file.size;\n        const hasTempFilePath = file.tempFilePath;\n        const hasFile = file.file;\n\n        const isValid = hasUrl || hasPath || hasResponse || isString || hasFileId || hasName || hasSize || hasTempFilePath || hasFile;\n        return isValid;\n    });\n\n    if (validFiles.length === 0) {\n        uni.showToast({\n            title: '请至少上传1张图片',\n            icon: 'none'\n        });\n        return;\n    }\n\n    // 检查文件数量限制\n    if (validFiles.length > maxImageCount) {\n        uni.showToast({\n            title: `最多只能上传${maxImageCount}张图片`,\n            icon: 'none'\n        });\n        return;\n    }\n\n\n    confirmReport(index);\n   \n};\n\n//确认收运上报\nconst confirmReport = async (index) => { \n    const record = records.value[index];\n    // 模拟桶编码数据\n    const bucketCode = 'BC' + new Date().getTime();\n    \n    // 构造上报数据\n    const reportData = {\n        bucketCode: bucketCode, // 桶编码\n        weight: parseFloat(record.weight), // 垃圾重量改为小数类型\n        carId: carId.value, // 车辆ID\n        driverId: driverId.value, // 司机ID\n        merchantId: merchantId.value, // 商户ID\n        planId: planId.value, // 收运单ID\n        img: record.images.map(image => {\n            // 根据不同情况获取图片URL\n            if (image.url) return image.url;\n            if (image.path) return image.path;\n            if (image.response && image.response.url) return image.response.url;\n            if (typeof image === 'string') return image;\n            return '';\n        }).filter(url => url !== '').join(',') // 过滤掉空的URL并用逗号连接\n    };\n    \n    try {\n        const res = await apiPostreportWeight(reportData);\n        if (res.code === 200) {\n            uni.showToast({\n                title: '上报成功',\n                icon: 'success'\n            });\n            \n            // 设置为已确认状态\n            record.isConfirmed = true;\n        } else {\n            uni.showToast({\n                title: res.message || '上报失败',\n                icon: 'none'\n            });\n        }\n    } catch (error) {\n        uni.showToast({\n            title: '上报异常',\n            icon: 'none'\n        });\n        console.error('上报异常:', error);\n    }\n};\n\n</script>\n\n<style lang=\"scss\" scoped>\n.container {\n    height: 100vh;\n    display: flex;\n    flex-direction: column;\n    background-color: $bg-theme-color;\n}\n\n// 添加商店信息样式\n.store-info {\n    padding: 24rpx;\n    background-color: #FFFFFF;\n    margin: 20rpx;\n    border-radius: 20rpx;\n\n    .store-name {\n        font-size: 16px;\n        font-weight: 500;\n        color: #333333;\n        margin-bottom: 16rpx;\n    }\n\n    .bin-info {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        font-size: 14px;\n        color: #666666;\n\n        .scan-icon {\n            cursor: pointer;\n        }\n    }\n}\n\n.content {\n    flex: 1;\n    overflow: auto;\n\n    .record-list {\n        padding: 24rpx;\n\n        .record-card {\n            background-color: #FFFFFF;\n            border-radius: 16rpx;\n            padding: 32rpx;\n            margin-bottom: 24rpx;\n\n            .input-group {\n                margin-bottom: 32rpx;\n\n                .input-item {\n                    margin-bottom: 24rpx;\n\n                    &:last-child {\n                        margin-bottom: 0;\n                    }\n\n                    .label {\n                        display: block;\n                        font-size: 14px;\n                        color: #333333;\n                        margin-bottom: 16rpx;\n\n                        .required {\n                            color: #FF4D4F;\n                            margin-right: 8rpx;\n                        }\n                    }\n\n                    .input {\n                        height: 88rpx;\n                        background-color: #F5F5F5;\n                        border-radius: 8rpx;\n                        padding: 0 24rpx;\n                        font-size: 14px;\n                    }\n\n                    // 下划线样式输入框\n                    .underline-input {\n                        height: 88rpx;\n                        background-color: transparent;\n                        border: none;\n                        border-bottom: 1px solid #e0e0e0;\n                        border-radius: 0;\n                        padding: 0 8rpx;\n                        font-size: 14px;\n                        box-shadow: none;\n\n                        &:focus {\n                            outline: none;\n                            border-bottom: 1px solid #07C160;\n                        }\n\n                        // 只读状态样式\n                        &[disabled] {\n                            background-color: #f5f5f5;\n                            color: #999;\n                            -webkit-text-fill-color: #999; // 防止iOS设备上disabled文字变淡\n                            opacity: 1; // 防止某些浏览器中disabled元素透明度变化\n                        }\n                        \n                        &.readonly-input {\n                            background-color: #f5f5f5;\n                            color: #999;\n                        }\n                    }\n                }\n            }\n\n            .upload-section {\n                margin-bottom: 32rpx;\n\n                .label {\n                    display: block;\n                    font-size: 14px;\n                    color: #333333;\n                    margin-bottom: 16rpx;\n\n                    .required {\n                        color: #FF4D4F;\n                        margin-right: 8rpx;\n                    }\n                }\n\n                .upload-area {\n                    margin-top: 16rpx;\n\n                    .upload-tip {\n                        font-size: 12px;\n                        color: #999999;\n                        line-height: 1.5;\n                        margin-top: 16rpx;\n                    }\n                }\n            }\n\n            .button-group {\n                position: relative;\n                height: 48rpx;\n                margin-top: 32rpx;\n\n                .btn {\n                    position: absolute;\n                    right: 0;\n                    width: 144rpx;\n                    height: 48rpx;\n                    line-height: 48rpx;\n                    text-align: center;\n                    border-radius: 100rpx;\n                    font-size: 14px;\n\n                    &.btn-cancel {\n                        right: 164rpx;\n                        /* 144rpx宽度 + 20rpx间距 */\n                        background-color: #F5F5F5;\n                        color: #666666;\n                    }\n\n                    &.btn-confirm {\n                        right: 0;\n                        background-color: #07C160;\n                        color: #FFFFFF;\n                    }\n                }\n            }\n        }\n    }\n}\n</style>","import MiniProgramPage from '/Users/yx/Documents/Vue3Projects/cycl/pages/collection/syReport.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","ref","createUploadHeaders","onLoad","apiPostreportWeight"],"mappings":";;;;;;;;;;;;;;;;AAkFA,MAAM,gBAAgB;;;;AAPtB,UAAM,OAAO,MAAM;AAEfA,0BAAI,MAAM,kBAAkB;AAC5BA,oBAAG,MAAC,aAAY;AAAA,IACpB;AAEA,UAAM,QAAQC,cAAAA,IAAI,CAAC;AAKnB,UAAM,QAAQA,cAAAA,IAAI,EAAE;AACpB,UAAM,WAAWA,cAAAA,IAAI,EAAE;AACvB,UAAM,aAAaA,cAAAA,IAAI,EAAE;AACzB,UAAM,SAASA,cAAAA,IAAI,EAAE;AAErB,UAAM,gBAAgBC,aAAAA,oBAAqB;AAE3C,UAAM,UAAUD,cAAAA,IAAI;AAAA,MAChB;AAAA,QACI,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,QAAQ,CAAE;AAAA;AAAA,QACV,aAAa;AAAA;AAAA,MAChB;AAAA,IACL,CAAC;AAGDE,kBAAM,OAAC,CAAC,YAAY;AAChB,UAAI,QAAQ;AAAO,cAAM,QAAQ,QAAQ;AACzC,UAAI,QAAQ;AAAU,iBAAS,QAAQ,QAAQ;AAC/C,UAAI,QAAQ;AAAY,mBAAW,QAAQ,QAAQ;AACnD,UAAI,QAAQ;AAAQ,eAAO,QAAQ,QAAQ;AAC3CH,oBAAA,MAAA,MAAA,OAAA,wCAAY,WAAW,OAAO;AAAA,IAClC,CAAC;AAGD,UAAM,mBAAmB,CAAC,OAAO,UAAU;AAEvC,UAAI,MAAM,aAAa,MAAM,UAAU,SAAS,GAAG;AAE/C,cAAM,YAAY,CAAC,GAAI,QAAQ,MAAM,KAAK,EAAE,UAAU,CAAE,GAAG,GAAG,MAAM,SAAS;AAE7E,gBAAQ,MAAM,KAAK,EAAE,SAAS;AAAA,MACjC;AAAA,IACL;AAEA,UAAM,oBAAoB,CAAC,OAAO,UAAU;AACxCA,oBAAA,MAAA,MAAA,OAAA,wCAAY,UAAU,KAAK;AAAA,IAC/B;AAEA,UAAM,iBAAiB,CAAC,OAAO,UAAU;AACrCA,oBAAA,MAAA,MAAA,OAAA,wCAAY,UAAU,KAAK;AAAA,IAC/B;AAEA,UAAM,aAAa,MAAM;AAErBA,oBAAAA,MAAI,SAAS;AAAA,QACT,SAAS,CAAC,QAAQ;AACdA,wBAAA,MAAA,MAAA,OAAA,wCAAY,QAAQ,GAAG;AAEvB,kBAAQ,MAAM,KAAK;AAAA,YACf,UAAU;AAAA,YACV,QAAQ;AAAA,YACR,QAAQ,CAAE;AAAA,YACV,aAAa;AAAA;AAAA,UAC7B,CAAa;AAED,gBAAM;AAAA,QACT;AAAA,QACD,MAAM,CAAC,QAAQ;AACXA,wBAAA,MAAA,MAAA,OAAA,wCAAY,QAAQ,GAAG;AAEvB,kBAAQ,MAAM,KAAK;AAAA,YACf,UAAU;AAAA,YACV,QAAQ;AAAA,YACR,QAAQ,CAAE;AAAA,YACV,aAAa;AAAA;AAAA,UAC7B,CAAa;AAED,gBAAM;AAAA,QACT;AAAA,MACT,CAAK;AAAA,IACL;AAEA,UAAM,eAAe,CAAC,UAAU;AAE5B,UAAI,QAAQ,MAAM,UAAU,GAAG;AAC3BA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAGDA,oBAAAA,MAAI,UAAU;AAAA,QACV,OAAO;AAAA,QACP,SAAS;AAAA,QACT,SAAS,CAAC,QAAQ;AACd,cAAI,IAAI,SAAS;AAEb,oBAAQ,MAAM,OAAO,OAAO,CAAC;AAE7B,kBAAM;AAAA,UACT;AAAA,QACJ;AAAA,MACT,CAAK;AAAA,IACL;AAGA,UAAM,gBAAgB,CAAC,UAAU;AAC7B,YAAM,SAAS,QAAQ,MAAM,KAAK;AAGlC,UAAI,CAAC,OAAO,UAAU,OAAO,OAAO,KAAM,MAAK,IAAI;AAC/CA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAID,UAAI,OAAO,WAAW,UAAa,OAAO,WAAW,MAAM;AACvDA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAGD,UAAI,CAAC,MAAM,QAAQ,OAAO,MAAM,GAAG;AAC/BA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAGD,UAAI,OAAO,OAAO,WAAW,GAAG;AAC5BA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAGD,YAAM,aAAa,OAAO,OAAO,OAAO,CAAC,SAAS;AAC9C,YAAI,CAAC,MAAM;AACP,iBAAO;AAAA,QACV;AAGD,cAAM,SAAS,KAAK,OAAO,KAAK,IAAI;AACpC,cAAM,UAAU,KAAK,QAAQ,KAAK,KAAK;AACvC,cAAM,cAAc,KAAK,YAAY,KAAK,SAAS;AACnD,cAAM,WAAW,OAAO,SAAS,YAAY,KAAK,KAAI;AACtD,cAAM,YAAY,KAAK,UAAU,KAAK;AACtC,cAAM,UAAU,KAAK;AACrB,cAAM,UAAU,KAAK;AACrB,cAAM,kBAAkB,KAAK;AAC7B,cAAM,UAAU,KAAK;AAErB,cAAM,UAAU,UAAU,WAAW,eAAe,YAAY,aAAa,WAAW,WAAW,mBAAmB;AACtH,eAAO;AAAA,MACf,CAAK;AAED,UAAI,WAAW,WAAW,GAAG;AACzBA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAGD,UAAI,WAAW,SAAS,eAAe;AACnCA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO,SAAS,aAAa;AAAA,UAC7B,MAAM;AAAA,QAClB,CAAS;AACD;AAAA,MACH;AAGD,oBAAc,KAAK;AAAA,IAEvB;AAGA,UAAM,gBAAgB,OAAO,UAAU;AACnC,YAAM,SAAS,QAAQ,MAAM,KAAK;AAElC,YAAM,aAAa,QAAO,oBAAI,KAAM,GAAC,QAAO;AAG5C,YAAM,aAAa;AAAA,QACf;AAAA;AAAA,QACA,QAAQ,WAAW,OAAO,MAAM;AAAA;AAAA,QAChC,OAAO,MAAM;AAAA;AAAA,QACb,UAAU,SAAS;AAAA;AAAA,QACnB,YAAY,WAAW;AAAA;AAAA,QACvB,QAAQ,OAAO;AAAA;AAAA,QACf,KAAK,OAAO,OAAO,IAAI,WAAS;AAE5B,cAAI,MAAM;AAAK,mBAAO,MAAM;AAC5B,cAAI,MAAM;AAAM,mBAAO,MAAM;AAC7B,cAAI,MAAM,YAAY,MAAM,SAAS;AAAK,mBAAO,MAAM,SAAS;AAChE,cAAI,OAAO,UAAU;AAAU,mBAAO;AACtC,iBAAO;AAAA,QACnB,CAAS,EAAE,OAAO,SAAO,QAAQ,EAAE,EAAE,KAAK,GAAG;AAAA;AAAA,MAC7C;AAEI,UAAI;AACA,cAAM,MAAM,MAAMI,6BAAoB,UAAU;AAChD,YAAI,IAAI,SAAS,KAAK;AAClBJ,wBAAAA,MAAI,UAAU;AAAA,YACV,OAAO;AAAA,YACP,MAAM;AAAA,UACtB,CAAa;AAGD,iBAAO,cAAc;AAAA,QACjC,OAAe;AACHA,wBAAAA,MAAI,UAAU;AAAA,YACV,OAAO,IAAI,WAAW;AAAA,YACtB,MAAM;AAAA,UACtB,CAAa;AAAA,QACJ;AAAA,MACJ,SAAQ,OAAO;AACZA,sBAAAA,MAAI,UAAU;AAAA,UACV,OAAO;AAAA,UACP,MAAM;AAAA,QAClB,CAAS;AACDA,sBAAc,MAAA,MAAA,SAAA,wCAAA,SAAS,KAAK;AAAA,MAC/B;AAAA,IACL;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3TA,GAAG,WAAW,eAAe;"}