{"version":3,"file":"shSignature.js","sources":["pages/syContract/shSignature.vue","pages/syContract/shSignature.vue?type=page"],"sourcesContent":["<template>\n    <view class=\"signature-container\">\n        <!-- 自定义导航栏 -->\n        <view class=\"custom-nav-bar\" :style=\"navBarStyle\">\n            <!-- 状态栏占位 - 定位到胶囊按钮位置 -->\n            <view class=\"status-bar\" :style=\"statusBarStyle\"></view>\n\n            <!-- 导航栏内容 - 定位到胶囊按钮位置 -->\n            <view class=\"nav-content\" :style=\"navContentStyle\">\n                <!-- 左侧返回按钮 -->\n                <view class=\"nav-left\" @click=\"back\">\n                    <uni-icons type=\"left\" size=\"20\" color=\"#000\"></uni-icons>\n                </view>\n\n                <!-- 中间标题 -->\n                <view class=\"nav-title\">{{ contractTitle }}</view>\n\n                <!-- 右侧占位 -->\n                <view class=\"nav-right\"></view>\n            </view>\n        </view>\n\n\n        <!-- 签名弹窗 -->\n        <view class=\"signature-modal-native\">\n            <view style=\"width: 100%; height: 100%;\">\n                <l-signature ref=\"signatureRef\" :penColor=\"penColor\" :penSize=\"penSize\" :openSmooth=\"openSmooth\"\n                    openSmooth></l-signature>\n            </view>\n\n            <view class=\"signature-buttons-rotated\">\n                <button class=\"signature-btn clear-btn\" @click=\"clearSignature\">清空</button>\n                <button class=\"signature-btn undo-btn\" @click=\"undoSignature\">撤销</button>\n                <button class=\"signature-btn save-btn\" @click=\"saveSignature\">保存</button>\n                <button class=\"signature-btn cancel-btn\" @click=\"cancelSignature\">取消</button>\n            </view>\n        </view>\n    </view>\n</template>\n\n<script setup>\nimport { ref, computed, onMounted } from 'vue'\nimport { onLoad, onUnload } from '@dcloudio/uni-app'\nimport { uploadUrl, createUploadHeaders } from '@/utils/config.js'\n\n// 页面参数\nconst contractId = ref('')\nconst contractTitle = ref('合同签名')\n\n// 导航栏相关数据\nconst statusBarHeight = ref(0)\nconst navBarHeight = ref(44) // 默认导航栏高度\nconst menuButtonInfo = ref({})\nconst useFixedHeight = ref(false) // 临时使用固定高度测试\n\n// 签名相关数据\nconst penColor = ref('black')\nconst penSize = ref(3)\nconst openSmooth = ref(true)\nconst signatureRef = ref(null)\n\n// 上传相关\nconst uploadHeaders = createUploadHeaders()\n\n/**\n * 计算导航栏样式\n */\nconst navBarStyle = computed(() => {\n    let totalHeight\n    if (useFixedHeight.value) {\n        // 使用固定高度测试\n        totalHeight = 88 // 固定88px测试\n        console.log('使用固定高度测试:', totalHeight)\n    } else {\n        // 导航栏总高度 = 胶囊按钮的top + 胶囊按钮高度\n        if (menuButtonInfo.value.top) {\n            totalHeight = menuButtonInfo.value.top + menuButtonInfo.value.height\n        } else {\n            totalHeight = statusBarHeight.value + navBarHeight.value\n        }\n    }\n    return {\n        height: totalHeight + 'px',\n        '--nav-bar-height': totalHeight + 'px'\n    }\n})\n\n/**\n * 计算状态栏样式 - 定位到胶囊按钮位置\n */\nconst statusBarStyle = computed(() => {\n    if (menuButtonInfo.value.top) {\n        // 胶囊按钮的top是相对于整个屏幕的，所以直接使用\n        const top = menuButtonInfo.value.top\n        return {\n            position: 'absolute',\n            top: top + 'px',\n            left: '0',\n            right: '0',\n            height: menuButtonInfo.value.height + 'px'\n        }\n    } else {\n        // 默认样式\n        return {\n            height: navBarHeight.value + 'px'\n        }\n    }\n})\n\n/**\n * 计算导航栏内容样式 - 定位到胶囊按钮位置\n */\nconst navContentStyle = computed(() => {\n    if (menuButtonInfo.value.top) {\n        // 胶囊按钮的top是相对于整个屏幕的，所以直接使用\n        const top = menuButtonInfo.value.top\n        return {\n            position: 'absolute',\n            top: top + 'px',\n            left: '0',\n            right: '0',\n            height: menuButtonInfo.value.height + 'px'\n        }\n    } else {\n        // 默认样式\n        return {\n            height: navBarHeight.value + 'px'\n        }\n    }\n})\n\n/**\n * 获取系统信息并计算导航栏高度\n */\nconst initNavBar = () => {\n    try {\n        // 获取系统信息\n        const systemInfo = uni.getSystemInfoSync()\n        statusBarHeight.value = systemInfo.statusBarHeight || 0\n\n        // 获取胶囊按钮信息\n        const menuButton = uni.getMenuButtonBoundingClientRect()\n        if (menuButton) {\n            menuButtonInfo.value = menuButton\n            // 导航栏应该和胶囊按钮在同一行，所以导航栏高度就是胶囊按钮的高度\n            navBarHeight.value = menuButton.height\n        } else {\n            // 如果没有胶囊按钮信息，使用默认高度\n            navBarHeight.value = 44\n        }\n\n    } catch (error) {\n        console.error('获取系统信息失败:', error)\n        // 使用默认值\n        statusBarHeight.value = 20\n        navBarHeight.value = 44\n    }\n}\n\n// 页面加载\nonLoad((options) => {\n    contractId.value = options.contractId || ''\n    contractTitle.value = options.title || '合同签名'\n    // 初始化导航栏\n    initNavBar()\n})\n\n// 页面卸载时清理\nonUnload(() => {\n    // 清理工作\n    console.log('签名页面卸载')\n})\n\n// 清空签名\nconst clearSignature = () => {\n    if (signatureRef.value) {\n        try {\n            signatureRef.value.clear()\n        } catch (error) {\n            console.warn('清空签名失败:', error)\n        }\n    }\n}\n\n// 撤销签名\nconst undoSignature = () => {\n    if (signatureRef.value) {\n        try {\n            signatureRef.value.undo()\n        } catch (error) {\n            console.warn('撤销签名失败:', error)\n        }\n    }\n}\n\n// 保存签名\nconst saveSignature = () => {\n    if (!signatureRef.value) {\n        uni.showToast({\n            title: '签名组件未加载',\n            icon: 'none'\n        })\n        return\n    }\n\n    signatureRef.value.canvasToTempFilePath({\n        success: (res) => {\n            if (res.isEmpty) {\n                uni.showToast({\n                    title: '请先进行签名',\n                    icon: 'none'\n                })\n                return\n            }\n\n            // 显示上传中提示\n            uni.showLoading({\n                title: '上传签名中...'\n            })\n\n            // 上传签名到服务器\n            uni.uploadFile({\n                url: uploadUrl,\n                filePath: res.tempFilePath,\n                name: 'file',\n                header: uploadHeaders.value,\n                success: (uploadRes) => {\n                    uni.hideLoading()\n\n                    try {\n                        const response = JSON.parse(uploadRes.data)\n                        if (response.code === 200 && response.url) {\n                            uni.showToast({\n                                title: '签名保存成功',\n                                icon: 'success'\n                            })\n                            console.log('签名上传成功:', uploadRes)\n                            // 返回上一页并传递签名数据\n                            setTimeout(() => {\n                                console.log('===== shSignature.vue 准备返回 =====')\n                                console.log('执行uni.navigateBack，delta: 1')\n                                uni.navigateBack({\n                                    delta: 1,\n                                    success: () => {\n                                        console.log('shSignature.vue uni.navigateBack 成功')\n                                        // 通过事件传递签名数据\n                                        console.log('发送signatureUpdated事件')\n                                        uni.$emit('signatureUpdated', {\n                                            partyB: response.url\n                                        })\n                                    },\n                                    fail: (err) => {\n                                        console.error('shSignature.vue uni.navigateBack 失败:', err)\n                                    }\n                                })\n                            }, 1500)\n                        } else {\n                            throw new Error(response.message || '上传失败')\n                        }\n                    } catch (error) {\n                        console.error('解析上传响应失败:', error)\n                        uni.showToast({\n                            title: '上传失败，请重试',\n                            icon: 'none'\n                        })\n                    }\n                },\n                fail: (error) => {\n                    uni.hideLoading()\n                    console.error('上传签名失败:', error)\n                    uni.showToast({\n                        title: '上传失败，请重试',\n                        icon: 'none'\n                    })\n                }\n            })\n        },\n        fail: (error) => {\n            console.error('保存签名失败:', error)\n            uni.showToast({\n                title: '保存签名失败',\n                icon: 'none'\n            })\n        }\n    })\n}\n\n// 取消签名\nconst cancelSignature = () => {\n    uni.showModal({\n        title: '确认取消',\n        content: '确定要取消签名吗？',\n        success: (res) => {\n            if (res.confirm) {\n                uni.navigateBack()\n            }\n        }\n    })\n}\n\n// 返回上一页\nconst back = () => {\n    uni.navigateBack()\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.signature-container {\n    width: 100vw;\n    min-height: 100vh;\n    background: #f5f5f5;\n}\n\n// 自定义导航栏样式\n.custom-nav-bar {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    background-color: #fff;\n    z-index: 999;\n    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);\n}\n\n.status-bar {\n    width: 100%;\n    background-color: #fff;\n}\n\n.nav-content {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 0 15px;\n    background-color: #fff;\n    height: 100%; // 确保占满整个导航栏高度\n}\n\n.nav-left {\n    width: 40px;\n    height: 100%;\n    display: flex;\n    align-items: center;\n    justify-content: flex-start;\n}\n\n.nav-title {\n    flex: 1;\n    text-align: center;\n    font-size: 18px;\n    font-weight: 600;\n    color: #000;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    padding: 0 10px;\n}\n\n.nav-right {\n    width: 40px;\n    height: 100%;\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n}\n\n/* 横屏适配 */\n@media screen and (orientation: landscape) {\n    .custom-nav-bar {\n        .nav-content {\n            padding: 0 20px;\n        }\n    }\n}\n\n/* 微信小程序适配 */\n/* #ifdef MP-WEIXIN */\n.custom-nav-bar {\n    .nav-content {\n        padding-right: calc(env(safe-area-inset-right) + 10px);\n    }\n}\n\n/* #endif */\n\n.signature-modal-native {\n    width: 100vw;\n    height: 100vh;\n    background: #fff;\n    border-radius: 0;\n    overflow: hidden;\n    position: fixed;\n    z-index: 2;\n    top: 0;\n    left: 0;\n    /* 为导航栏留出空间 */\n    padding-top: var(--nav-bar-height, 40px);\n\n    .signature-buttons-rotated {\n        position: absolute;\n        right: 20rpx;\n        top: 50vh; // 直接使用视口高度的50%\n        transform: translateY(-50%);\n        display: flex;\n        flex-direction: column;\n        gap: 15rpx;\n        z-index: 10;\n        background: rgba(255, 255, 255, 0.9);\n        padding: 10rpx;\n\n        .signature-btn {\n            height: 28rpx;\n            width: 80rpx;\n            border-radius: 30rpx;\n            font-size: 20rpx;\n            border: none;\n            line-height: 25rpx;\n            text-align: center;\n            background: #07c160;\n            color: #fff;\n\n            // &.clear-btn {\n            //     background: #ff4444;\n            //     color: #fff;\n            // }\n\n            // &.undo-btn {\n            //     background: #ff9500;\n            //     color: #fff;\n            // }\n\n            // &.save-btn {\n            //     background: #07c160;\n            //     color: #fff;\n            // }\n\n            // &.cancel-btn {\n            //     background: #999;\n            //     color: #fff;\n            // }\n        }\n    }\n}\n</style>","import MiniProgramPage from '/Users/yx/Documents/Vue3Projects/cycl/pages/syContract/shSignature.vue'\nwx.createPage(MiniProgramPage)"],"names":["ref","createUploadHeaders","computed","uni","onLoad","onUnload","uploadUrl"],"mappings":"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"}